{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <h1 class="my-4 text-center" style="color: #6a1b9a;">Leads Generator</h1>

    <!-- Search Form -->
    <form id="search-form" class="d-flex flex-column align-items-center mb-5" method="POST" action="{{ url_for('search') }}">
        <div class="input-group" style="max-width: 600px; width: 100%;">
            <input type="text" name="business_type" class="form-control rounded-pill shadow-sm" 
                   placeholder="e.g., Plumbers in Brooklyn, NY" 
                   aria-label="Search" 
                   aria-describedby="search-button" 
                   style="border: 2px solid #6a1b9a;" required>
        </div>
        <button class="btn btn-purple rounded-pill mt-3 shadow-lg d-flex align-items-center justify-content-center" 
                type="submit" 
                id="search-button" 
                style="background-color: #8e24aa; color: #ffffff; padding: 0 20px; width: 100%; max-width: 150px; position: relative;">
            <i class="fas fa-search"></i> 
            <span class="ms-2">Search</span>
            <div id="loader" class="spinner-border text-light ms-2" role="status" style="display: none; width: 20px; height: 20px;">
                <span class="visually-hidden">Loading...</span>
            </div>
        </button>
    </form>

    <!-- Leads Display Card -->
    <div class="card shadow-lg mx-auto" style="max-width: 800px; border-radius: 15px; border: 2px solid #8e24aa; transition: transform 0.3s ease, box-shadow 0.3s ease;">
        <div class="card-body">
            <h5 class="card-title text-center" style="color: #8e24aa;">Generated Leads</h5>
            <hr>
            {% if not leads %}
            <p class="text-center" style="color: #777777;">
                Enter a search query and click the "Search" button to generate leads. Here's an example of what you might see:
            </p>
            <ul class="list-group list-group-flush" id="leads-list" style="max-height: 150px; overflow-y: auto;">
                <li class="list-group-item">
                    <strong style="color: #6a1b9a;">Example</strong><br><br>
                    <strong style="font-size: 1.2rem; color: #6a1b9a;">Joe's Plumbing</strong><br>
                    <strong style="color: #777777;">Email:</strong> contact@joesplumbing.com<br>
                    <strong style="color: #777777;">Phone No:</strong> (555) 123-4567<br>
                    <strong style="color: #777777;">Address:</strong> 123 Main St, Los Angeles, CA<br>
                    <strong style="color: #777777;">Social Media:</strong> facebook.com/joesplumbing
                </li>
            </ul>
            {% else %}
            <ul class="list-group list-group-flush" id="leads-list" style="max-height: 150px; overflow-y: auto;">
                {% for lead in leads %}
                <li class="list-group-item" {% if loop.index > 10 %}style="display: none;"{% endif %}>
                    <strong style="font-size: 1.2rem; color: #6a1b9a;">{{ lead['info']['company_name'] or "N/A" }}</strong><br>
                    <strong style="color: #777777;">Email:</strong> {{ lead['info']['emails'] | join(', ') or 'None' }}<br>
                    <strong style="color: #777777;">Phone No:</strong> {{ lead['info']['phone_numbers'] | join(', ') or 'None' }}<br>
                    <strong style="color: #777777;">Address:</strong> {{ lead['info']['addresses'] | join(', ') or 'None' }}<br>
                    <strong style="color: #777777;">Social Media:</strong> {{ lead['info']['social_media'] | join(', ') or 'None' }}<br>
                    <a href="{{ lead['link'] }}" target="_blank">Visit Website</a>
                </li>
                {% endfor %}
            </ul>
            {% endif %}
        </div>
    </div>

    <!-- Buttons -->
    <div class="text-center my-4 d-flex flex-wrap justify-content-center justify-content-md-between">
        <button id="copy-phones" class="btn btn-outline-purple mx-3 my-2 shadow-lg" 
                style="border-color: #8e24aa; color: #8e24aa; transition: transform 0.3s ease, box-shadow 0.3s ease;">
            <i class="fas fa-phone-alt"></i> Copy Phone Numbers
        </button>
        <button id="copy-emails" class="btn btn-outline-purple mx-3 my-2 shadow-lg" 
                style="border-color: #8e24aa; color: #8e24aa; transition: transform 0.3s ease, box-shadow 0.3s ease;">
            <i class="fas fa-envelope"></i> Copy Emails
        </button>
        <button id="download-leads" class="btn btn-purple mx-3 my-2 shadow-lg" 
                style="background-color: #8e24aa; color: #ffffff; transition: transform 0.3s ease, box-shadow 0.3s ease;">
            <i class="fas fa-download"></i> Download Leads
        </button>
    </div>
</div>

<style>
    .card:hover, .btn:hover {
        transform: translateY(-5px); /* Floating effect */
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); /* Deepened shadow */
    }
    
    #leads-list {
        max-height: 150px;
        overflow-y: auto;
    }

    #leads-list li {
        display: block;
        transition: opacity 0.3s ease;
    }

    /* Adjusting the search button size based on screen width */
    @media (max-width: 768px) {
        #search-button {
            width: 100%; /* Full width on mobile */
            font-size: 1.2rem; /* Bigger text for better visibility */
        }
    }

    @media (min-width: 768px) {
        #search-button {
            max-width: 200px; /* Smaller on larger screens */
        }

        .d-flex.justify-content-md-between {
            justify-content: space-between; /* Properly aligns buttons on desktop */
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchForm = document.getElementById('search-form');
        const searchButton = document.getElementById('search-button');
        const loader = document.getElementById('loader');

        searchForm.addEventListener('submit', () => {
            loader.style.display = 'inline-block'; // Show loader when search starts
        });

        const copyPhonesButton = document.getElementById('copy-phones');
        const copyEmailsButton = document.getElementById('copy-emails');
        const downloadLeadsButton = document.getElementById('download-leads');

        copyPhonesButton.addEventListener('click', () => {
            const phoneNumbers = [];
            document.querySelectorAll('#leads-list .list-group-item').forEach(item => {
                const phoneText = item.innerHTML.match(/Phone No:<\/strong>\s*([^<]+)/);
                if (phoneText && phoneText[1] !== 'None') {
                    phoneNumbers.push(phoneText[1].trim());
                }
            });
            copyToClipboard(phoneNumbers.join('\n'));
        });

        copyEmailsButton.addEventListener('click', () => {
            const emails = [];
            document.querySelectorAll('#leads-list .list-group-item').forEach(item => {
                const emailText = item.innerHTML.match(/Email:<\/strong>\s*([^<]+)/);
                if (emailText && emailText[1] !== 'None') {
                    emails.push(emailText[1].trim());
                }
            });
            copyToClipboard(emails.join('\n'));
        });

        downloadLeadsButton.addEventListener('click', () => {
            const leads = [];
            document.querySelectorAll('#leads-list .list-group-item').forEach(item => {
                const companyName = item.querySelector('strong:first-child').textContent.trim();
                const emailText = item.innerHTML.match(/Email:<\/strong>\s*([^<]+)/);
                const phoneText = item.innerHTML.match(/Phone No:<\/strong>\s*([^<]+)/);
                const addressText = item.innerHTML.match(/Address:<\/strong>\s*([^<]+)/);
                const socialMediaText = item.innerHTML.match(/Social Media:<\/strong>\s*([^<]+)/);

                leads.push({
                    'Company Name': companyName,
                    'Email': emailText && emailText[1] !== 'None' ? emailText[1].trim() : '',
                    'Phone Number': phoneText && phoneText[1] !== 'None' ? phoneText[1].trim() : '',
                    'Address': addressText && addressText[1] !== 'None' ? addressText[1].trim() : '',
                    'Social Media': socialMediaText && socialMediaText[1] !== 'None' ? socialMediaText[1].trim() : '',
                });
            });

            downloadCSV(leads);
        });

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function downloadCSV(data) {
            const headers = Object.keys(data[0]);
            const csv = [headers.join(',')];

            data.forEach(row => {
                const values = headers.map(header => `"${row[header]}"`);
                csv.push(values.join(','));
            });

            const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(csvFile);
            downloadLink.download = 'leads.csv';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
    });
</script>

{% endblock %}
